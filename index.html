function ScannerComponent({ onScan, lastScanned, onConfirm, onCancel }) {
            const [manualCode, setManualCode] = useState('');
            const [cameraError, setCameraError] = useState('');
            const [scannedTextDisplay, setScannedTextDisplay] = useState('');
            const videoRef = useRef(null);
            const codeReaderRef = useRef(null);
            const [forceRefresh, setForceRefresh] = useState(0);

            // 1. Inisialisasi CodeReader SEKALI saja saat mount
            useEffect(() => {
                codeReaderRef.current = new ZXing.BrowserMultiFormatReader();
                return () => {
                    if (codeReaderRef.current) {
                        codeReaderRef.current.reset();
                        codeReaderRef.current = null;
                    }
                };
            }, []);

            // 2. Kontrol Kamera (Start/Stop)
            useEffect(() => {
                // Jika sedang menampilkan hasil scan (lastScanned ada), stop kamera
                if (lastScanned) {
                    if (codeReaderRef.current) codeReaderRef.current.reset();
                    return;
                }

                // Jika reader belum siap
                if (!codeReaderRef.current) return;

                let isMounted = true; 

                const startCamera = async () => {
                    try {
                        const codeReader = codeReaderRef.current;
                        codeReader.reset(); // Reset dulu untuk keamanan

                        const videoInputDevices = await codeReader.listVideoInputDevices();
                        // Pilih kamera belakang atau default
                        const backCamera = videoInputDevices.find(device => device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('environment'));
                        const selectedDeviceId = backCamera ? backCamera.deviceId : (videoInputDevices.length > 0 ? videoInputDevices[0].deviceId : null);

                        if (!selectedDeviceId) {
                            if(isMounted) setCameraError("Kamera tidak ditemukan.");
                            return;
                        }

                        // Delay sedikit untuk stabilitas perpindahan state
                        await new Promise(r => setTimeout(r, 500));
                        if (!isMounted) return;

                        if (videoRef.current) {
                            // Mulai decode
                            await codeReader.decodeFromVideoDevice(selectedDeviceId, videoRef.current, (result, err) => {
                                if (!isMounted) return;
                                if (result) {
                                    const text = result.getText();
                                    setScannedTextDisplay(text);
                                    if (text.length >= 3) {
                                        // Stop scanning seketika setelah dapat hasil
                                        codeReader.reset();
                                        onScan(text);
                                    }
                                }
                            });
                            if(isMounted) setCameraError('');
                        }
                    } catch (err) {
                        console.error("Camera Error:", err);
                        if(isMounted) setCameraError("Gagal akses kamera. Coba tombol refresh di pojok kanan.");
                    }
                };

                startCamera();

                return () => {
                    isMounted = false;
                    if (codeReaderRef.current) {
                        codeReaderRef.current.reset();
                    }
                };
            }, [lastScanned, forceRefresh, onScan]); // Dependency list diperbarui

            return (
                <div className="flex flex-col h-full bg-black relative animate-fade-in">
                    <div className="flex-1 bg-black flex flex-col items-center justify-center relative overflow-hidden rounded-xl border border-slate-800 m-4">
                        
                        {/* Area Video */}
                        {!lastScanned && (
                            <video ref={videoRef} className="w-full h-full object-cover" muted playsInline />
                        )}

                        {/* Overlay Kotak Scan */}
                        {!lastScanned && !cameraError && (
                            <>
                                <div className="scanner-overlay"><div className="scan-corner tl"></div><div className="scan-corner tr"></div><div className="scan-corner bl"></div><div className="scan-corner br"></div></div>
                                {scannedTextDisplay && (<div className="absolute bottom-10 bg-black/50 text-cyan-400 px-4 py-2 rounded-full backdrop-blur font-mono text-xs border border-cyan-500/30">Mendeteksi QR: {scannedTextDisplay}...</div>)}
                            </>
                        )}
                        
                        {/* Tombol Refresh Manual */}
                        {!lastScanned && (
                            <button onClick={()=>setForceRefresh(p=>p+1)} className="absolute top-4 right-4 bg-black/50 p-2 rounded-full text-white z-20 hover:bg-white/20 border border-white/10" title="Refresh Kamera"><RefreshCw size={16}/></button>
                        )}

                        {/* Error State */}
                        {cameraError && !lastScanned && (
                            <div className="absolute inset-0 flex items-center justify-center bg-slate-900/90 text-center p-6 z-10">
                                <div><Camera size={48} className="mx-auto mb-4 text-red-500" /><p className="text-white font-bold">Kamera Error</p><p className="text-xs text-slate-400 mt-2">{cameraError}</p></div>
                            </div>
                        )}

                        {/* RESULT VIEW (TAMPILAN HASIL SCAN) */}
                        {lastScanned && (
                            <div className="absolute inset-0 z-30 bg-slate-900 flex flex-col items-center justify-center p-6 animate-fade-in">
                                <div className={`w-24 h-24 rounded-full flex items-center justify-center mb-6 shadow-2xl ${lastScanned.status === 'success' ? 'bg-green-600 text-white shadow-green-900/50' : 'bg-yellow-600 text-white shadow-yellow-900/50'}`}>
                                    {lastScanned.status === 'success' ? <Check size={48}/> : <Info size={48}/>}
                                </div>
                                <h2 className="text-2xl font-bold text-white text-center mb-1">{lastScanned.member.name}</h2>
                                <p className="text-cyan-400 font-bold mb-6">{lastScanned.member.class}</p>
                                <div className="bg-black/40 p-4 rounded-xl border border-slate-700 w-full mb-6">
                                    <p className="text-center text-sm text-slate-300">
                                        {lastScanned.status === 'success' 
                                            ? `Berhasil absen pada ${lastScanned.time.toLocaleTimeString()}` 
                                            : `Sudah absen sebelumnya hari ini.`}
                                    </p>
                                </div>
                                <div className="flex gap-3 w-full">
                                    <button onClick={onConfirm} className="flex-1 py-4 bg-white text-black font-bold rounded-xl hover:bg-slate-200 transition-colors shadow-lg active:scale-95 transition-transform">
                                        SCAN LAGI
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Manual Input (Hanya tampil jika tidak ada hasil scan) */}
                    {!lastScanned && (
                        <div className="p-4 bg-slate-900 border-t border-slate-800">
                            <form onSubmit={(e)=>{e.preventDefault(); onScan(manualCode); setManualCode('');}} className="flex gap-2">
                                <input value={manualCode} onChange={e=>setManualCode(e.target.value.toUpperCase())} className="flex-1 bg-black border border-slate-700 text-white px-4 py-3 rounded-xl outline-none focus:border-cyan-500 font-mono text-center tracking-widest placeholder:tracking-normal" placeholder="KODE MANUAL (RA...)" />
                                <button className="bg-cyan-600 hover:bg-cyan-500 text-white px-6 rounded-xl font-bold transition-colors">CEK</button>
                            </form>
                        </div>
                    )}
                </div>
            )
        }
