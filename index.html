function ScannerComponent({ onScan, lastScanned, onConfirm, onCancel }) {
            const [manualCode, setManualCode] = useState('');
            const [cameraError, setCameraError] = useState('');
            const [scannedTextDisplay, setScannedTextDisplay] = useState('');
            const videoRef = useRef(null);
            const [isLibReady, setIsLibReady] = useState(false);
            const readerRef = useRef(null);

            // 1. Cek Library
            useEffect(() => {
                const checkInterval = setInterval(() => {
                    if (window.ZXing && typeof window.ZXing.BrowserMultiFormatReader === 'function') {
                        setIsLibReady(true);
                        clearInterval(checkInterval);
                    }
                }, 500);
                return () => clearInterval(checkInterval);
            }, []);

            // 2. Logika Kamera Stabil (Clean Start/Stop)
            useEffect(() => {
                if (!isLibReady || lastScanned) return;

                let selectedDeviceId = null;
                const codeReader = new window.ZXing.BrowserMultiFormatReader();
                readerRef.current = codeReader;

                const startCamera = async () => {
                    try {
                        // 1. Dapatkan device ID kamera belakang
                        const videoInputDevices = await codeReader.listVideoInputDevices();
                        const backCamera = videoInputDevices.find(device => 
                            device.label.toLowerCase().includes('back') || 
                            device.label.toLowerCase().includes('belakang') ||
                            device.label.toLowerCase().includes('environment')
                        );
                        selectedDeviceId = backCamera ? backCamera.deviceId : (videoInputDevices[0]?.deviceId || null);

                        if (!selectedDeviceId) throw new Error("Kamera tidak ditemukan");

                        // 2. Tunggu elemen video siap
                        if (!videoRef.current) return;

                        // 3. Mulai decode
                        await codeReader.decodeFromVideoDevice(selectedDeviceId, videoRef.current, (result, err) => {
                            if (result) {
                                const text = result.getText();
                                if(text && text.length >= 3) {
                                    // STOP KAMERA SEBELUM PINDAH STATE
                                    stopCamera();
                                    onScan(text);
                                }
                            }
                        });
                        setCameraError('');
                    } catch (err) {
                        console.error("Camera Error:", err);
                        if (err.name !== 'NotFoundException') {
                            setCameraError("Gagal akses kamera. Coba refresh halaman.");
                        }
                    }
                };

                const stopCamera = () => {
                    if (readerRef.current) {
                        readerRef.current.reset();
                        readerRef.current = null;
                    }
                    // Paksa matikan stream di elemen video
                    if (videoRef.current && videoRef.current.srcObject) {
                        const tracks = videoRef.current.srcObject.getTracks();
                        tracks.forEach(track => track.stop());
                        videoRef.current.srcObject = null;
                    }
                };

                // Delay sedikit untuk memastikan DOM stabil
                const timer = setTimeout(startCamera, 500);

                return () => {
                    clearTimeout(timer);
                    stopCamera();
                };
            }, [isLibReady, lastScanned, onScan]);

            return (
                <div className="flex flex-col h-full bg-black relative animate-fade-in">
                    <div className="flex-1 bg-black flex flex-col items-center justify-center relative overflow-hidden rounded-xl border border-slate-800 m-4">
                        
                        {/* TAMPILAN KAMERA */}
                        {!lastScanned ? (
                            <>
                                {isLibReady ? (
                                    <video 
                                        ref={videoRef} 
                                        className="w-full h-full object-cover" 
                                        muted 
                                        playsInline 
                                    />
                                ) : (
                                    <div className="text-white text-xs animate-pulse">Menyiapkan Kamera...</div>
                                )}
                                
                                {/* Overlay Kotak */}
                                {!cameraError && (
                                    <>
                                        <div className="scanner-overlay"><div className="scan-corner tl"></div><div className="scan-corner tr"></div><div className="scan-corner bl"></div><div className="scan-corner br"></div></div>
                                        {scannedTextDisplay && (<div className="absolute bottom-10 bg-black/50 text-cyan-400 px-4 py-2 rounded-full backdrop-blur font-mono text-xs border border-cyan-500/30">Mendeteksi...</div>)}
                                    </>
                                )}

                                {/* Tombol Refresh Manual */}
                                <button onClick={() => window.location.reload()} className="absolute top-4 right-4 bg-black/50 p-2 rounded-full text-white z-20 hover:bg-white/20 border border-white/10" title="Refresh Halaman Jika Error">
                                    <RefreshCw size={16}/>
                                </button>
                            </>
                        ) : (
                            /* TAMPILAN HASIL SCAN (LastScanned) */
                            <div className="absolute inset-0 z-30 bg-slate-900 flex flex-col items-center justify-center p-6 animate-fade-in">
                                <div className={`w-24 h-24 rounded-full flex items-center justify-center mb-6 shadow-2xl ${lastScanned.status === 'success' ? 'bg-green-600 text-white shadow-green-900/50' : 'bg-yellow-600 text-white shadow-yellow-900/50'}`}>
                                    {lastScanned.status === 'success' ? <Check size={48}/> : <Info size={48}/>}
                                </div>
                                <h2 className="text-2xl font-bold text-white text-center mb-1">{lastScanned.member.name}</h2>
                                <p className="text-cyan-400 font-bold mb-6">{lastScanned.member.class}</p>
                                <div className="bg-black/40 p-4 rounded-xl border border-slate-700 w-full mb-6">
                                    <p className="text-center text-sm text-slate-300">
                                        {lastScanned.status === 'success' 
                                            ? `Berhasil absen pada ${lastScanned.time.toLocaleTimeString()}` 
                                            : `Sudah absen sebelumnya hari ini.`}
                                    </p>
                                </div>
                                <button onClick={onConfirm} className="w-full py-4 bg-white text-black font-bold rounded-xl hover:bg-slate-200 transition-colors shadow-lg active:scale-95 transition-transform">
                                    SCAN LAGI
                                </button>
                            </div>
                        )}

                        {/* Error State */}
                        {cameraError && !lastScanned && (
                            <div className="absolute inset-0 flex items-center justify-center bg-slate-900/95 text-center p-6 z-10">
                                <div>
                                    <Camera size={48} className="mx-auto mb-4 text-red-500" />
                                    <p className="text-white font-bold">Kamera Error</p>
                                    <p className="text-xs text-slate-400 mt-2 mb-4">{cameraError}</p>
                                    <button onClick={() => window.location.reload()} className="px-4 py-2 bg-slate-800 rounded-lg text-xs text-white border border-slate-700">Refresh Halaman</button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Manual Input */}
                    {!lastScanned && (
                        <div className="p-4 bg-slate-900 border-t border-slate-800">
                            <form onSubmit={(e)=>{e.preventDefault(); onScan(manualCode); setManualCode('');}} className="flex gap-2">
                                <input value={manualCode} onChange={e=>setManualCode(e.target.value.toUpperCase())} className="flex-1 bg-black border border-slate-700 text-white px-4 py-3 rounded-xl outline-none focus:border-cyan-500 font-mono text-center tracking-widest placeholder:tracking-normal" placeholder="KODE MANUAL (RA...)" />
                                <button className="bg-cyan-600 hover:bg-cyan-500 text-white px-6 rounded-xl font-bold transition-colors">CEK</button>
                            </form>
                        </div>
                    )}
                </div>
            )
        }

        // --- BARCODE MODAL (FIXED - DOWNLOAD WITH NAME & CLASS) ---
        function BarcodeModal({ member, onClose }) {
            const qrRef = useRef(null);
            
            useEffect(() => {
                const renderQR = setTimeout(() => {
                    if (qrRef.current) {
                        qrRef.current.innerHTML = "";
                        try { 
                            new QRCode(qrRef.current, { 
                                text: member.barcode, 
                                width: 250, 
                                height: 250, 
                                colorDark : "#000000", 
                                colorLight : "#ffffff", 
                                correctLevel : QRCode.CorrectLevel.H 
                            }); 
                        } catch(e) { console.error("QR Error", e); }
                    }
                }, 100); 
                return () => clearTimeout(renderQR);
            }, [member]);

            const downloadWithInfo = () => {
                const qrImg = qrRef.current.querySelector("img");
                if (!qrImg) return;

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set ukuran canvas (QR + space untuk teks)
                const width = 400;
                const height = 500;
                canvas.width = width;
                canvas.height = height;

                // Background Putih
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, width, height);

                // Gambar QR di tengah
                // QR asli 250x250, kita gambar di posisi x=75, y=50
                ctx.drawImage(qrImg, 75, 50, 250, 250);

                // Setup Teks
                ctx.fillStyle = "#000000";
                ctx.textAlign = "center";

                // Nama Siswa (Bold, Besar)
                ctx.font = "bold 24px Arial";
                ctx.fillText(member.name, width / 2, 350);

                // Kelas (Sedikit lebih kecil)
                ctx.font = "20px Arial";
                ctx.fillText(member.class, width / 2, 385);

                // ID (Kecil di bawah)
                ctx.fillStyle = "#666666";
                ctx.font = "14px monospace";
                ctx.fillText(member.barcode, width / 2, 420);

                // Footer Branding (Opsional)
                ctx.fillStyle = "#0891b2"; // Cyan color
                ctx.font = "bold 16px Arial";
                ctx.fillText("E-ABSENSI RESPATI 24", width / 2, 460);

                // Download
                const link = document.createElement('a');
                link.download = `Kartu_Absen_${member.name.replace(/\s+/g, '_')}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.9);
                link.click();
            };

            return (
                <div className="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
                    <div className="bg-slate-900 w-full max-w-sm p-6 rounded-2xl border border-slate-700 flex flex-col items-center shadow-2xl">
                        <h3 className="text-xl font-bold text-white text-center mb-1">{member.name}</h3>
                        <p className="text-cyan-400 mb-6">{member.class}</p>
                        
                        {/* Container Putih untuk QR */}
                        <div className="bg-white p-4 rounded-xl w-full flex justify-center mb-6 shadow-inner aspect-square items-center">
                            <div ref={qrRef} className="bg-white p-2"></div> 
                        </div>

                        <div className="flex gap-3 w-full">
                            <button onClick={onClose} className="flex-1 py-3 border border-slate-600 text-slate-400 font-bold rounded-xl hover:bg-slate-800 transition-colors">Tutup</button>
                            <button onClick={downloadWithInfo} className="flex-1 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-xl shadow-lg transition-colors flex items-center justify-center gap-2">
                                <Download size={16}/> Simpan
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
