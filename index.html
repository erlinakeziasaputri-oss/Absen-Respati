function ScannerComponent({ onScan, lastScanned, onConfirm, onCancel }) {
            const [manualCode, setManualCode] = useState('');
            const [cameraError, setCameraError] = useState('');
            const [scannedTextDisplay, setScannedTextDisplay] = useState('');
            const videoRef = useRef(null);
            const codeReaderRef = useRef(null);
            const [isLibReady, setIsLibReady] = useState(false);
            const [forceMount, setForceMount] = useState(0); // Trigger ulang kamera

            // 1. Cek Ketersediaan Library ZXing (Anti-Crash)
            useEffect(() => {
                const checkInterval = setInterval(() => {
                    if (window.ZXing && typeof window.ZXing.BrowserMultiFormatReader === 'function') {
                        setIsLibReady(true);
                        clearInterval(checkInterval);
                    }
                }, 500);

                // Timeout 15 detik jika internet lemot banget
                const timeout = setTimeout(() => {
                    clearInterval(checkInterval);
                    if (!window.ZXing) setCameraError("Gagal memuat sistem scanner. Periksa koneksi internet.");
                }, 15000);

                return () => {
                    clearInterval(checkInterval);
                    clearTimeout(timeout);
                };
            }, []);

            // 2. Logika Kamera (Start/Stop/Restart)
            useEffect(() => {
                // Jangan jalan kalau: Library belum siap ATAU sedang menampilkan hasil scan
                if (!isLibReady || lastScanned) {
                    // Pastikan kamera mati jika sedang menampilkan hasil
                    if (codeReaderRef.current) codeReaderRef.current.reset();
                    return;
                }

                let isActive = true; // Flag untuk mencegah memory leak

                const initCamera = async () => {
                    try {
                        // Reset reader lama jika ada
                        if (codeReaderRef.current) {
                            codeReaderRef.current.reset();
                        }

                        // Buat instance baru
                        const hints = new Map();
                        hints.set(window.ZXing.DecodeHintType.POSSIBLE_FORMATS, [window.ZXing.BarcodeFormat.QR_CODE]);
                        const codeReader = new window.ZXing.BrowserMultiFormatReader(hints);
                        codeReaderRef.current = codeReader;

                        // Tunggu elemen video siap (PENTING: Jeda sedikit agar DOM React selesai render)
                        await new Promise(r => setTimeout(r, 100));
                        if (!videoRef.current) {
                            // Jika video ref belum ada, coba lagi nanti (force update)
                            if (isActive) setTimeout(() => setForceMount(prev => prev + 1), 500);
                            return;
                        }

                        // Cari kamera belakang
                        const videoInputDevices = await codeReader.listVideoInputDevices();
                        const backCamera = videoInputDevices.find(device => 
                            device.label.toLowerCase().includes('back') || 
                            device.label.toLowerCase().includes('belakang') ||
                            device.label.toLowerCase().includes('environment')
                        );
                        
                        // Default ke kamera pertama jika tidak ada kamera belakang
                        const selectedDeviceId = backCamera ? backCamera.deviceId : (videoInputDevices[0]?.deviceId || null);

                        if (!selectedDeviceId) throw new Error("Kamera tidak ditemukan");

                        if (isActive && videoRef.current) {
                            await codeReader.decodeFromVideoDevice(selectedDeviceId, videoRef.current, (result, err) => {
                                if (!isActive) return;
                                if (result) {
                                    const text = result.getText();
                                    if (text) {
                                        setScannedTextDisplay(text);
                                        // Delay sedikit biar user lihat ada respon
                                        if (text.length >= 3) {
                                            codeReader.reset(); // Matikan kamera
                                            onScan(text);
                                        }
                                    }
                                }
                            });
                            setCameraError(''); // Clear error jika berhasil jalan
                        }

                    } catch (err) {
                        console.error("Camera Error:", err);
                        if (isActive) {
                            // Abaikan error 'NotFoundException' (biasa terjadi saat scanning frame kosong)
                            if (err?.name !== 'NotFoundException') {
                                setCameraError("Gagal akses kamera. Pastikan izin diberikan.");
                            }
                        }
                    }
                };

                initCamera();

                return () => {
                    isActive = false;
                    if (codeReaderRef.current) {
                        codeReaderRef.current.reset();
                        codeReaderRef.current = null;
                    }
                };
            }, [isLibReady, lastScanned, forceMount, onScan]); // Dependency list diperbaiki

            return (
                <div className="flex flex-col h-full bg-black relative animate-fade-in">
                    <div className="flex-1 bg-black flex flex-col items-center justify-center relative overflow-hidden rounded-xl border border-slate-800 m-4">
                        
                        {/* TAMPILAN KAMERA */}
                        {!lastScanned ? (
                            <>
                                {isLibReady ? (
                                    <video 
                                        ref={videoRef} 
                                        className="w-full h-full object-cover" 
                                        muted 
                                        playsInline // Penting untuk iOS
                                    />
                                ) : (
                                    <div className="text-white text-xs animate-pulse">Menyiapkan Kamera...</div>
                                )}
                                
                                {/* Overlay Kotak */}
                                {!cameraError && (
                                    <>
                                        <div className="scanner-overlay"><div className="scan-corner tl"></div><div className="scan-corner tr"></div><div className="scan-corner bl"></div><div className="scan-corner br"></div></div>
                                        {scannedTextDisplay && (<div className="absolute bottom-10 bg-black/50 text-cyan-400 px-4 py-2 rounded-full backdrop-blur font-mono text-xs border border-cyan-500/30">Mendeteksi: {scannedTextDisplay}</div>)}
                                    </>
                                )}

                                {/* Tombol Refresh Manual */}
                                <button onClick={() => setForceMount(p => p + 1)} className="absolute top-4 right-4 bg-black/50 p-2 rounded-full text-white z-20 hover:bg-white/20 border border-white/10" title="Refresh Kamera">
                                    <RefreshCw size={16}/>
                                </button>
                            </>
                        ) : (
                            /* TAMPILAN HASIL SCAN (LastScanned) */
                            <div className="absolute inset-0 z-30 bg-slate-900 flex flex-col items-center justify-center p-6 animate-fade-in">
                                <div className={`w-24 h-24 rounded-full flex items-center justify-center mb-6 shadow-2xl ${lastScanned.status === 'success' ? 'bg-green-600 text-white shadow-green-900/50' : 'bg-yellow-600 text-white shadow-yellow-900/50'}`}>
                                    {lastScanned.status === 'success' ? <Check size={48}/> : <Info size={48}/>}
                                </div>
                                <h2 className="text-2xl font-bold text-white text-center mb-1">{lastScanned.member.name}</h2>
                                <p className="text-cyan-400 font-bold mb-6">{lastScanned.member.class}</p>
                                <div className="bg-black/40 p-4 rounded-xl border border-slate-700 w-full mb-6">
                                    <p className="text-center text-sm text-slate-300">
                                        {lastScanned.status === 'success' 
                                            ? `Berhasil absen pada ${lastScanned.time.toLocaleTimeString()}` 
                                            : `Sudah absen sebelumnya hari ini.`}
                                    </p>
                                </div>
                                <button onClick={onConfirm} className="w-full py-4 bg-white text-black font-bold rounded-xl hover:bg-slate-200 transition-colors shadow-lg active:scale-95 transition-transform">
                                    SCAN LAGI
                                </button>
                            </div>
                        )}

                        {/* Error State */}
                        {cameraError && !lastScanned && (
                            <div className="absolute inset-0 flex items-center justify-center bg-slate-900/95 text-center p-6 z-10">
                                <div>
                                    <Camera size={48} className="mx-auto mb-4 text-red-500" />
                                    <p className="text-white font-bold">Kamera Error</p>
                                    <p className="text-xs text-slate-400 mt-2 mb-4">{cameraError}</p>
                                    <button onClick={() => window.location.reload()} className="px-4 py-2 bg-slate-800 rounded-lg text-xs text-white border border-slate-700">Refresh Halaman</button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Manual Input */}
                    {!lastScanned && (
                        <div className="p-4 bg-slate-900 border-t border-slate-800">
                            <form onSubmit={(e)=>{e.preventDefault(); onScan(manualCode); setManualCode('');}} className="flex gap-2">
                                <input value={manualCode} onChange={e=>setManualCode(e.target.value.toUpperCase())} className="flex-1 bg-black border border-slate-700 text-white px-4 py-3 rounded-xl outline-none focus:border-cyan-500 font-mono text-center tracking-widest placeholder:tracking-normal" placeholder="KODE MANUAL (RA...)" />
                                <button className="bg-cyan-600 hover:bg-cyan-500 text-white px-6 rounded-xl font-bold transition-colors">CEK</button>
                            </form>
                        </div>
                    )}
                </div>
            )
        }
